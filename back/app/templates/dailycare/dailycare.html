{% extends "base.html" %}
{% block title %}반려동물의 목소리가 들려 -데일리케어{% endblock %}
{% block content %}

<link rel="stylesheet" href=".././../static/css/dailycare/dailcare.css">
<link rel="stylesheet" href="../../static/css/dailycare/todo.css">

<input type="hidden" id="user-id" value="{{ user_id }}">
<div class="bg-gray-50 pb-20">
    <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="dailycare-main-container">
                
                <!-- 사이드바 - 캘린더와 건강리포트 -->
                <div class="dailycare-sidebar">
                    <!-- 캘린더 위젯 -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-xl font-bold mb-4 text-gray-800">
                            <i class="fas fa-calendar text-orange-400 mr-2"></i>
                            캘린더
                        </h2>
                        <div class="calendar-widget">
                            <div class="calendar-header">
                                <button id="prev-month" class="btn btn-secondary">◀</button>
                                <strong id="current-month"></strong>
                                <button id="next-month" class="btn btn-secondary">▶</button>
                            </div>
                            <div class="calendar-grid" id="calendar-grid">
                            
                            </div>
                        </div>
                    </div>

                    <!-- 건강 리포트 위젯 -->
                    <div class="health-report-widget">
                        <h3>📊 이번주 건강 리포트</h3>
                        <div class="health-score"></div>
                        <p style="text-align: center; opacity: 0.9;"></p>
                        <a class="btn btn-secondary" style="background: rgba(255,255,255,0.2); color: white; border: none; width: 100%;" href="/dailycare/analysis">📈 전체 리포트 보기</a>
                    </div>
                </div>
                
                <!-- 메인 콘텐츠 영역 -->
                <div class="dailycare-content">

                    <!-- 케어 기록 폼 영역 -->
                    <div class="care-record-section mb-6">
                <div class="section-card">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="section-title mb-0">
                            <i class="fas fa-heart text-red-500 mr-3"></i>
                            오늘의 케어 기록
                        </h2>
                        
                        <!-- 펫카드 스타일 드롭다운 -->
                        <div class="relative">
                            <button id="pet-selector-btn" class="pet-card-dropdown bg-gradient-to-r from-orange-50 to-yellow-50 border-2 border-orange-300 rounded-xl p-4 hover:from-orange-100 hover:to-yellow-100 hover:border-orange-400 focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all duration-200 min-w-48 shadow-sm">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <span class="text-2xl" id="selected-pet-icon">🐾</span>
                                        <div class="text-left">
                                            <div class="font-semibold text-gray-800" id="selected-pet-name">동물을 선택하세요</div>
                                            <div class="text-sm text-gray-500" id="selected-pet-species"></div>
                                        </div>
                                    </div>
                                    <svg class="w-4 h-4 text-gray-400 transition-transform" id="dropdown-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </div>
                            </button>
                            
                            <!-- 드롭다운 메뉴 -->
                            <div id="pet-dropdown-menu" class="hidden absolute top-full left-0 right-0 mt-2 bg-white border border-gray-200 rounded-xl shadow-lg z-50 max-h-64 overflow-y-auto">
                                <!-- JavaScript에서 동적으로 펫 옵션들이 추가됩니다 -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="nav-tabs">
                        <button class="nav-tab active" onclick="switchTab(event,'daily')">건강 기록</button>
                        <button class="nav-tab" onclick="switchTab(event,'schedule')">TODO</button>
                    </div>
                    
                    <div id="daily-tab" class="tab-content active">
                        <form class="daily-care-form">
                            <!-- 먹이 -->
                            <div class="form-group">
                                <label>🍽️ 먹이</label>
                                <input type="number" id="food-input" placeholder="g 단위로 입력">
                            </div>
                            <!-- 급수량 -->
                            <div class="form-group">
                                <label>💧 급수량</label>
                                <input type="number" id="water-input" placeholder="ml 단위로 입력">
                            </div>
                            <!-- 배변 -->
                            <div class="form-group">
                                <label>💩 배변 상태</label>
                                <select id="poop-select">
                                    <option>정상</option>
                                    <option>설사</option>
                                    <option>변비</option>
                                    <option>혈변</option>
                                </select>
                            </div>
                            <!-- 몸무게 -->
                            <div class="form-group">
                                <label>⚖️ 몸무게</label>
                                <input type="number" step="0.1" id="weight-input" placeholder="kg 단위로 입력">
                            </div>
                            <!-- 산책시간 -->
                            <div class="form-group">
                                <label>🚶 산책 시간</label>
                                <input type="number" id="walk-input" placeholder="분 단위로 입력">
                            </div>
                    
                        <div class="form-group mb-4">
                            <label class="block text-gray-700 font-medium mb-2">💊 약/영양제</label>

                            <!-- 셀렉트 박스 -->
                         <select id="medication-select" class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-yellow-400">
    <option value="">약물을 선택하세요</option>
</select>

                            <!-- 선택된 태그 표시 영역 -->
                            <div id="selected-tags" 
                                class="flex flex-wrap gap-2 mt-3">
                                <!-- JS로 태그 추가됨 -->
                            </div>
                            </div>
                        </form>
                        <div class="quick-actions">
                            <button class="btn btn-primary" id="save_healthcare">📝 기록 저장</button>
                            <button class="btn btn-secondary" id="link_healthcare_history" data-pet-id="">📊 기록 보기</button>
                        </div>
                    </div>
                    
                    
                    <div id="schedule-tab" class="tab-content">
                        <div class="todo-content">
                            <div id="todo_div"></div>
                            <div class="todo-actions">
                                <button class="btn btn-primary" id="create_todo" data-user-id="{{ user }}">➕ 일정 추가</button>
                                <a href="/dailycare/todo" class="btn btn-secondary">📋 전체 일정</a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 컴팩트한 의료기록 관리 섹션 -->
                <div class="medical-record-section mb-6">
                    <div class="section-card">
                        <h2 class="section-title">
                            <i class="fas fa-stethoscope text-blue-500 mr-3"></i>
                            의료기록 관리
                        </h2>
                        
                        <div class="compact-health-grid">
                            <div class="health-item-compact mdc" data-modal="allergy">
                                <h4>🤧 알러지 정보 <span>음식, 환경 알러지 등록</span></h4>
                            </div>
                            <div class="health-item-compact mdc" data-modal="disease">
                                <h4>🏥 질병 이력 <span>과거 질병 및 치료 기록</span></h4>
                            </div>
                            <div class="health-item-compact mdc" data-modal="surgery">
                                <h4>⚕️ 수술 이력 <span>수술 날짜 및 내용 기록</span></h4>
                            </div>
                            <div class="health-item-compact mdc" data-modal="vaccination">
                                <h4>💉 예방접종 <span>접종 기록 및 일정 관리</span></h4>
                            </div>
                            <div class="health-item-compact mdc" data-modal="medication">
                                <h4>💊 복용약물 <span>현재 복용 중인 약물 정보</span></h4>
                            </div>
                            <a href="#" onclick="goToMedicalHistory()" class="health-item-compact">
                                <h4>🔍 전체 기록 <span>의료기록을 모아 볼 수 있습니다</span></h4>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 플로팅 AI 상담 버튼 -->
    <div class="floating-chat-btn" onclick="openAIChat()">
        <i class="fas fa-robot"></i>
        <span class="tooltip">AI 건강상담</span>
    </div>
    
<!-- 공용 모달 -->
<div id="common-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="flex justify-between items-center mb-4">
      <button id="modal-close-btn" class="text-gray-500">&times;</button>
    </div> 
    <div id="modalContent" ></div> 
</div> 

<script>
function goToMedicalHistory() {
    const current_pet_id = localStorage.getItem('currentPetId')
    if (!current_pet_id) {
        alert("펫을 먼저 선택해주세요.");
        return;
    }
    window.location.href = `/dailycare/medication-history/${current_pet_id}`;
}

function openAIChat() {
    const current_pet_id = localStorage.getItem('currentPetId');
    if (!current_pet_id) {
        alert("먼저 반려동물을 선택해주세요.");
        return;
    }
    
    // 플로팅 버튼 숨기기
    const floatingBtn = document.querySelector('.floating-chat-btn');
    if (floatingBtn) {
        floatingBtn.style.display = 'none';
    }
    
    // AI 상담 모달 열기 - modal.js의 openModal 함수 사용
    if (typeof openModal === 'function') {
        openModal('care_chatbot', current_pet_id);
    } else {
        // Fallback: 직접 모달 열기
        fetch(`/api/dailycares/modal/care_chatbot?pet_id=${current_pet_id}`)
            .then((res) => {
                if (!res.ok) throw new Error("네트워크 오류");
                return res.text();
            })
            .then((html) => {
                const modal = document.getElementById("common-modal");
                const content = modal.querySelector("#modalContent");
                content.innerHTML = html;
                modal.classList.remove("hidden");
                
                // 닫기 버튼 이벤트
                const closeBtn = document.getElementById("modal-close-btn");
                if (closeBtn) {
                    closeBtn.onclick = () => {
                        modal.classList.add("hidden");
                        showFloatingButton();
                    };
                }
                
                // 모달 바깥 클릭 시 닫기
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        modal.classList.add("hidden");
                        showFloatingButton();
                    }
                };
            })
            .catch((err) => {
                console.error("AI 상담 모달 불러오기 실패:", err);
                alert("AI 상담을 불러오지 못했습니다.");
                showFloatingButton(); // 오류 시 플로팅 버튼 다시 보이기
            });
    }
}

// 플로팅 버튼 다시 보이기 함수
function showFloatingButton() {
    const floatingBtn = document.querySelector('.floating-chat-btn');
    if (floatingBtn) {
        floatingBtn.style.display = 'flex';
    }
}
</script>



<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
<script src="{{ url_for('static', filename='js/dailycare/care_chatbot.js', v=static_version) }}"></script>
<script src="{{ url_for('static', filename='js/dailycare/calender.js', v=static_version) }}"></script>
<script src="{{ url_for('static', filename='js/dailycare/care_base.js', v=static_version) }}"></script>
<script src="{{ url_for('static', filename='js/dailycare/modal.js', v=static_version) }}"></script>
<script src="{{ url_for('static', filename='js/dailycare/todo.js', v=static_version) }}"></script>
<script src="{{ url_for('static', filename='js/dailycare/dailycare.js', v=static_version) }}"></script>

      

{% endblock %}
